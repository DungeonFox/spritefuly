<!--
SPRITE HEX-GRAPH FLIPBOOK TOOL WITH TASKER (single-file, no deps)
================================================================

This is an extended version of the Hex‚ÄëGraph Sprite Flipbook Tool. It retains the original template
and recipe editors, registry system, pop‚Äëout viewer and atlas exporter, and adds a new "Tasker"
subsystem for automating the pop‚Äëout viewer. Tasks live in a separate manifest (tasks.json) and are
identified by stable hex IDs (namespace `tsk:`). A task is a list of commands executed sequentially
with optional delays. Commands are sent to the pop‚Äëout viewer via postMessage and can instruct the
viewer to pause/play, jump to specific frames, toggle layer visibility, adjust layer opacity, or
wait for a specified duration. Tasks can be loaded, edited and saved independently from templates
and recipes.

--------------------------------------------------------------------------------
FILE FORMATS (revision)
--------------------------------------------------------------------------------

In addition to the types documented in the original tool, there is now a new
`Task` node type. A combined registry may hold assets, rects, frames, templates,
layers, recipes and tasks in one merged manifest. Tasks are declared in
tasks.json but can be merged into the global registry like any other nodes.

Manifest envelope (unchanged):

```
{
  "manifestVersion": 1,
  "nodes": {
    ...
  },
  "roots": {
    "template": "tpl:0x...",     // template root id (optional)
    "recipe":   "anim:0x...",    // recipe root id (optional)
    "assets":   ["asset:0x..."], // loaded assets
    "tasks":    ["tsk:0x..."]    // list of task root IDs (optional)
  }
}
```

Task node schema:

```
ID: tsk:0x...
{
  "type": "Task",
  "name": "Jump & Pause",
  "commands": [
    { "cmd": "goToFrameIndex", "index": 0 },
    { "cmd": "play" },
    { "cmd": "wait", "duration": 1000 },
    { "cmd": "pause" },
    { "cmd": "setLayerVisibility", "layer": "anim:0x...", "visible": false },
    { "cmd": "setLayerOpacity", "layer": "anim:0x...", "opacity": 0.5 }
  ]
}
```

Commands supported by the built‚Äëin viewer:

* **play**: resumes playback.
* **pause**: pauses playback.
* **goToFrameIndex**: jumps to the specified frame index (0‚Äëbased). Frames are resolved from the
  recipe‚Äôs frame list.
* **setLayerVisibility**: toggles a layer‚Äôs `visible` flag. The `layer` field must reference a
  layer ID (anim:0x...).
* **setLayerOpacity**: sets a layer‚Äôs opacity (0..1). The `layer` field must reference a layer ID.
* **wait**: instructs the Tasker to wait the specified `duration` (in ms) before proceeding to
  the next command. Note: `wait` does not send anything to the viewer; it merely delays task
  execution.

* **setWindowGeometry**: resizes and/or moves the pop‚Äëout viewer window. It accepts optional
  `width`, `height`, `left` and `top` properties (numbers, in pixels). Any omitted property
  leaves that dimension or position unchanged. For example:

  ```
  { "cmd": "setWindowGeometry", "width": 640, "height": 480, "left": 200, "top": 100 }
  ```

  When run as part of a task, this command asks the viewer to resize itself to 640√ó480 pixels
  and move to screen coordinates (200,100). If only width/height are provided, the window stays
  anchored in its current position. If only left/top are provided, the size is preserved.

* **setWindowGeometryOnFrame**: like **setWindowGeometry** but deferred until the viewer
  reaches a specified frame. In addition to the geometry properties (`left`, `top`, `width`,
  `height`), it accepts one of `frameIndex` (number), `frameName` (string) or `frameId`
  (string). When a frame event matching the criteria is emitted by the viewer, the geometry
  changes are applied via `setWindowGeometry`. By default the trigger fires once; include
  `"repeat": true` to apply on every matching frame.

================================================================================
END README
================================================================================
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hex‚ÄëGraph Sprite Flipbook Tool with Tasker</title>
<link rel="stylesheet" href="styles.css">

</head>
<body>
<header>
  <div class="title">Hex‚ÄëGraph Sprite Flipbook Tool</div>
  <span class="pill">single‚Äëfile ‚Ä¢ offline ‚Ä¢ no deps</span>
  <span id="statusPill" class="pill">registry: 0 nodes</span>
  <div class="spacer"></div>
</header>

<div class="card-container">
  <div class="card-shell">
  <div class="tcg-card">
    <div class="card-header">
      <div class="card-header__title">
        Sprite Editor Deck
        <span id="playMini" class="card-header__status">stopped</span>
      </div>
      <div class="card-header__badge card-header__controls">
        <button id="btnPlay" class="card-control" type="button" title="Play/Pause preview" aria-label="Play or pause preview" aria-pressed="false">‚ñ∂</button>
        <button id="btnStep" class="card-control" type="button" title="Step preview" aria-label="Step preview frame">‚è≠</button>
        <button id="btnReset" class="card-control" type="button" title="Reset preview" aria-label="Reset preview">‚ü≤</button>
        <span class="card-header__divider" aria-hidden="true"></span>
        <button class="card-control card-control--toggle is-active" type="button" data-panel-toggle="registry" aria-pressed="true" title="Toggle registry panel" aria-label="Toggle registry panel">üóÇ</button>
        <button class="card-control card-control--toggle is-active" type="button" data-panel-toggle="log" aria-pressed="true" title="Toggle log panel" aria-label="Toggle log panel">üìú</button>
      </div>
    </div>
    <div class="card-image">
      <div class="card-image__frame">
        <canvas id="previewCanvas" width="256" height="256"></canvas>
        <div class="row card-image__meta" style="justify-content:space-between;">
          <div class="small muted">Frame: <span id="frameInfo" class="mono"></span></div>
          <div class="small muted">Size: <span id="sizeInfo" class="mono"></span></div>
        </div>
      </div>
    </div>
    <div class="card-type">Template Editor</div>
    <div class="card-text">
      <div class="card-text__body">Animation Recipe Builder</div>
    </div>
    <div class="editor-section">
      <div class="editor-section__header">
        <span>Editor Section</span>
        <span class="badge">Active</span>
      </div>
      <div class="main">
  <!-- TEMPLATE -->
  <section class="panel">
    <h2>
      <span>Template Editor <span class="mini" id="tplRootMini"></span></span>
      <span class="kbar">
        <input id="fileTemplate" type="file" accept=".json,application/json" />
        <button id="btnSaveTemplate">Save template.json</button>
      </span>
    </h2>
    <div class="content" id="templatePanel">
      <div class="grid2">
        <div class="field">
          <label>tileW / tileH</label>
          <div class="row">
            <input id="tplTileW" type="number" min="1" step="1" />
            <input id="tplTileH" type="number" min="1" step="1" />
          </div>
        </div>
        <div class="field">
          <label>gridW / gridH (output size = tileW√ógridW by tileH√ógridH)</label>
          <div class="row">
            <input id="tplGridW" type="number" min="1" step="1" />
            <input id="tplGridH" type="number" min="1" step="1" />
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div>
          <div class="muted small">Rects (source slices + destination placement)</div>
          <div class="small muted">IDs are stable refs. Rects are shared across layers.</div>
        </div>
        <div class="row">
          <button id="btnAddRect">+ Rect</button>
          <button id="btnDelRect" class="danger">Delete Selected</button>
        </div>
      </div>

      <div style="height:8px"></div>
      <div class="list" id="rectList"></div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div>
          <div class="muted small">Frame Slots (timeline)</div>
          <div class="small muted">Recipe overrides are keyed by FrameSlot IDs.</div>
        </div>
        <div class="row">
          <button id="btnAddFrame">+ FrameSlot</button>
          <button id="btnDelFrame" class="danger">Delete Selected</button>
        </div>
      </div>

      <div style="height:8px"></div>
      <div class="list" id="frameList"></div>
    </div>
  </section>

  <!-- RECIPE -->
  <section class="panel">
    <h2>
      <span>Animation Recipe Builder <span class="mini" id="recRootMini"></span></span>
      <span class="kbar">
        <input id="fileRecipe" type="file" accept=".json,application/json" />
        <button id="btnSaveRecipe">Save animation.json</button>
      </span>
    </h2>
    <div class="content" id="recipePanel">
      <div class="field">
        <label>Recipe ‚Üí Template Root</label>
        <select id="recipeTemplateSelect"></select>
        <div class="small muted" style="margin-top:6px">
          This recipe renders using the selected Template root node.
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div>
          <div class="muted small">Assets</div>
          <div class="small muted">Load images (embedded as data URLs for portability).</div>
        </div>
        <div class="row">
          <input id="fileAsset" type="file" accept="image/*" multiple />
          <button id="btnAddAsset">+ Empty Asset</button>
        </div>
      </div>

      <div style="height:8px"></div>
      <div class="list" id="assetList"></div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div>
          <div class="muted small">Layers</div>
          <div class="small muted">Each layer samples an Asset and draws a Rect, with per-frame overrides.</div>
        </div>
        <div class="row">
          <button id="btnAddLayer">+ Layer</button>
          <button id="btnDelLayer" class="danger">Delete Selected</button>
        </div>
      </div>

      <div style="height:8px"></div>
      <div class="list" id="layerList"></div>

      <div class="hr"></div>
      <div class="field">
        <label>Selected Layer Overrides (by FrameSlot)</label>
        <div class="small muted">Override rect and/or dx/dy/opacity for specific FrameSlots.</div>
        <div style="height:8px"></div>
        <div class="list" id="overrideList"></div>
      </div>
    </div>
  </section>

  <!-- TASKER -->
  <section class="panel">
    <h2>
      <span>Tasker Manager <span class="mini" id="taskRootMini"></span></span>
      <span class="kbar">
        <input id="fileTasker" type="file" accept=".json,application/json" />
        <button id="btnSaveTasks">Save tasks.json</button>
        <button id="btnRunTasks" class="primary">Run Tasks</button>
      </span>
    </h2>
    <div class="content" id="taskPanel">
      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div>
          <div class="muted small">Tasks</div>
          <div class="small muted">Define tasks that control the pop‚Äëout viewer.</div>
        </div>
        <div class="row">
          <button id="btnAddTask">+ Task</button>
          <button id="btnDelTask" class="danger">Delete Selected</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <div class="list" id="taskList"></div>
      <div class="hr"></div>
      <div class="field">
        <label>Selected Task Editor</label>
        <div class="small muted">Edit name and commands (as JSON array). Commands are executed sequentially.</div>
        <div class="row" style="gap:8px; margin-top:6px">
          <input id="taskNameInput" type="text" placeholder="Task name" style="flex:1" />
        </div>
        <div style="height:6px"></div>
        <textarea id="taskCommandsInput" placeholder='[{"cmd":"play"}]'></textarea>
        <div class="row" style="margin-top:6px; justify-content:flex-end">
          <button id="btnUpdateTask">Update Task</button>
        </div>
      </div>

      <!-- Pop‚Äëout viewer geometry controls -->
      <div class="hr"></div>
      <div class="field">
        <label>Pop‚Äëout Viewer Geometry</label>
        <div class="small muted">Configure the default size and screen position of the pop‚Äëout viewer. These values are used when opening a new viewer and can be applied to an open viewer at any time.</div>
        <div class="row" style="flex-wrap:wrap; gap:8px; margin-top:6px">
          <label for="popoutWidth" style="font-size:11px">W</label>
          <input id="popoutWidth" type="number" min="100" step="10" style="width:70px" />
          <label for="popoutHeight" style="font-size:11px">H</label>
          <input id="popoutHeight" type="number" min="100" step="10" style="width:70px" />
          <label for="popoutLeft" style="font-size:11px">Left</label>
          <input id="popoutLeft" type="number" step="10" style="width:70px" />
          <label for="popoutTop" style="font-size:11px">Top</label>
          <input id="popoutTop" type="number" step="10" style="width:70px" />
          <button id="popoutGeometryApply" class="primary">Apply</button>
        </div>
      </div>
    </div>
  </section>
      </div>
    </div>
    <div class="card-footer">
      <div class="kbar">
        <div class="toggle">
          <input id="deterministicIds" type="checkbox" checked />
          <label for="deterministicIds" title="Recompute IDs from canonical node content and rewrite references.">Deterministic IDs</label>
        </div>
        <button id="btnRehash" class="primary" title="Recompute IDs topologically; rewrite references; clears caches.">Recompute IDs</button>
        <button id="btnPopout" class="primary">Pop‚Äëout Viewer</button>
        <button id="btnExportAtlas" class="primary">Export Atlas PNG + JSON</button>
      </div>
    </div>
  </div>
  <aside class="card-adjacent" aria-label="Supplemental preview panels">
    <section class="panel side-panel" data-panel="registry">
      <h2>
        <span>Registry Manifests</span>
        <span class="mini">merged view</span>
      </h2>
      <div class="content rightStack">
        <div class="field">
          <label>Registry Manifests (merged view)</label>
          <textarea id="mergedJson" spellcheck="false"></textarea>
          <div class="row">
            <button id="btnCopyMerged">Copy</button>
            <button id="btnLoadMerged">Load (Merged JSON)</button>
          </div>
          <div class="small muted">
            Useful for debugging graph structure. Loading replaces current registry.
          </div>
        </div>
      </div>
    </section>
    <section class="panel side-panel" data-panel="log">
      <h2>
        <span>Log</span>
      </h2>
      <div class="content rightStack">
        <div class="field">
          <label>Log</label>
          <div id="log" class="log"></div>
        </div>
      </div>
    </section>
  </aside>
</div>
</div>
  <script defer src="js/01_utilities.js"></script>
  <script defer src="js/02_registry.js"></script>
  <script defer src="js/03_graph_helpers.js"></script>
  <script defer src="js/04_reid.js"></script>
  <script defer src="js/05_renderer.js"></script>
  <script defer src="js/06_popout.js"></script>
  <script defer src="js/ui/01_selection_ids.js"></script>
  <script defer src="js/ui/02_template_recipe.js"></script>
  <script defer src="js/ui/03_overrides_tasks.js"></script>
  <script defer src="js/ui/04_refresh_helpers.js"></script>
  <script defer src="js/07_io.js"></script>
  <script defer src="js/08_atlas_export.js"></script>
  <script defer src="js/09_task_runner.js"></script>
  <script defer src="js/events/00_core.js"></script>
  <script defer src="js/events/01_template.js"></script>
  <script defer src="js/events/02_rects.js"></script>
  <script defer src="js/events/03_frames.js"></script>
  <script defer src="js/events/04_assets.js"></script>
  <script defer src="js/events/05_layers.js"></script>
  <script defer src="js/events/06_tasks.js"></script>
  <script defer src="js/99_boot.js"></script>
</body>
</html>
